sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/m/MessageBox","sap/ui/model/Sorter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/ButtonType"],function(e,t,a,o,r,s,n,i,l,c,p){"use strict";var d="";var u=JSON.parse(localStorage.getItem("engTechUser"));var d={ui5User:u,status:[1,4]};var g={ui5User:u,status:[1,2,3,4]};var m=JSON.stringify(d);var f=JSON.stringify(g);var h="";return e.extend("Jepco.ISU.DM.smartmeter.controller.Main",{ui5UserModele:sap.ui.getCore().getModel("userModel"),onBuildingReportPress:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Report")},onStandardReportPress:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("StandRep")},onNewMeterReportPress:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("NewMeterRep")},onSuggest:function(e){},onReplacementReportPress:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("RepReport")},onQueryRound:function(){var e="https://portal.jepco.com.jo/JepcoSAPProxyPRD/SapProxy/GetDuplicates";var t=this.getView().byId("teamRound").getValue();var o=this.getView().byId("teamName").getSelectedItem().mProperties.text;o=o.toUpperCase();if(t==""&&o==""){a.alert("الرجاء ادخال اسم المستخدم للفرقة الفنية او رقم الجولة\t");return}var r="QRY-"+o+"-"+t;let s=this;$.ajax({type:"POST",url:e,dataType:"json",contentType:"application/json",data:JSON.stringify({strMeterNumber:r}),success:function(e,t,o){console.log(e,t,o);if(e.d.results.length=="0"){a.show("لا يوجد جولة مخصصة ")}var r=e;var n=s.getView().byId("idTableRound");var l=new sap.ui.model.json.JSONModel;l.setData(r);console.log(l);n.setModel(l);var c={busy:false,order:0};var l=new i(c);s.getView().setModel(l,"appView")},error:function(e){if(e.status=="200")a.confirm("تم الحفظ بنجاح");else a.alert(e.responseJSON.errors.error.message.value)}})},onQueryRoundChk:function(){var e="https://portal.jepco.com.jo/JepcoSAPProxyPRD/SapProxy/GetDuplicates";var t="";var a=this.getView().byId("teamName").getSelectedItem().mProperties.text;a=a.toUpperCase();var o="QRY-"+a+"-"+t;let r=this;$.ajax({type:"POST",url:e,dataType:"json",contentType:"application/json",data:JSON.stringify({strMeterNumber:o}),success:function(e,t,a){console.log(e,t,a);var o=e;var s=r.getView().byId("idTableRound");var n=new sap.ui.model.json.JSONModel;n.setData(o);console.log(n);s.setModel(n);var l={busy:false,order:0};var n=new i(l);r.getView().setModel(n,"appView")},error:function(e){}})},onDeleteRound:function(){var e=sap.ui.getCore().getModel().getProperty("/globalData/oUserName");var t="RONDD-"+e;var o="https://portal.jepco.com.jo/JepcoSAPProxyPRD/SapProxy/InsertTechNote";var r=this.getView().byId("teamRound").getValue();var s=this.getView().byId("teamName").getSelectedItem().mProperties.text;if(r==""||s==""){a.alert("الرجاء ادخال اسم المستخدم للفرقة الفنية ورقم الجولة\t");return}let n=this;$.ajax({type:"POST",url:o,dataType:"json",contentType:"application/json",data:JSON.stringify({Geraet:t,TarifDesc:"0",Tariftyp:"0",ImpimageOm:"0",ui5User:s,DuplicateAddr:r}),success:function(e,t,o){console.log(e,t,o);n.onQueryRoundChk();a.confirm("تمت عملية الحذف بنجاح")},error:function(e){if(e.status=="200"){n.onQueryRoundChk();a.confirm("تمت عملية الحذف بنجاح")}else a.alert(e.responseJSON.errors.error.message.value)}})},onSaveRound:function(){var e=sap.ui.getCore().getModel().getProperty("/globalData/oUserName");var t="RONDS-"+e;var o="https://portal.jepco.com.jo/JepcoSAPProxyPRD/SapProxy/InsertTechNote";var r=this.getView().byId("teamRound").getValue();var s=this.getView().byId("teamName").getSelectedItem().mProperties.text;if(r==""||s==""){a.alert("الرجاء ادخال اسم المستخدم للفرقة الفنية ورقم الجولة\t");return}let n=this;$.ajax({type:"POST",url:o,dataType:"json",contentType:"application/json",data:JSON.stringify({Geraet:t.toUpperCase(),TarifDesc:"0",Tariftyp:"0",ImpimageOm:"0",ui5User:s,DuplicateAddr:r}),success:function(e,t,o){console.log(e,t,o);n.onQueryRoundChk();a.confirm("تم الحفظ بنجاح")},error:function(e){if(e.status=="200"){n.onQueryRoundChk();a.confirm("تم الحفظ بنجاح")}else a.alert(e.responseJSON.errors.error.message.value)}})},onShowAll:function(){var e="https://portal.jepco.com.jo/JepcoSAPProxyPRD/SapProxy/GetDuplicates";var t="ALL";var o="QALL";let r=this;$.ajax({type:"POST",url:e,dataType:"json",contentType:"application/json",data:JSON.stringify({strMeterNumber:o}),success:function(e,t,a){console.log(e,t,a);var o=e;var s=r.getView().byId("idTableRound");var n=new sap.ui.model.json.JSONModel;n.setData(o);console.log(n);s.setModel(n);var l={busy:false,order:0};var n=new i(l);r.getView().setModel(n,"appView")},error:function(e){if(e.status=="200")a.confirm("تم الحفظ بنجاح");else a.alert(e.responseJSON.errors.error.message.value)}})},onNotePicPress:function(e){console.log(e.getSource().getBindingContext().getPath());var t=e.getSource().getBindingContext().getPath();console.log("lineNumber = ",t);t=t.substring(1);var a=this.getView().byId("idTechnicalNotes").getModel().oData[t].id;var o="https://portal.jepco.com.jo/MeterReplacmentPortalApisPRD/api/TbTechnicalNotesAndIncident/GetNotesByID?ID="+a+"";let r=this;$.ajax({type:"GET",url:o,dataType:"json",contentType:"application/json",success:function(e,t,a){console.log(e,t,a);var o=e[0].image;var r=new sap.m.HBox({alignItems:"Center",wrap:"Wrap",justifyContent:"Start",items:[new sap.m.Image({src:o,alt:"Tech Note image",height:"500px",mode:"Image",width:"600px"})]});this.oDefaultDialog=new l({title:"الصورة",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",content:[r]})],endButton:new c({text:"Close",press:function(){this.oDefaultDialog.close();this.oDefaultDialog.destroyContent()}.bind(this)})});this.oDefaultDialog.open()},error:function(e){console.log(e)}})},_handleRouteMatched:function(e){let t=this;console.log("array engTechUser ",u);u=JSON.parse(localStorage.getItem("engTechUser"));var a={async:true,crossDomain:true,url:"https://portal.jepco.com.jo/MeterReplacmentPortalApisPRD/api/TbMeterReplacment/GetAllDataWithoutImages",method:"POST",headers:{"content-type":"application/json","cache-control":"no-cache"},processData:false,data:m};$.ajax(a).done(function(e){var a=e;if(a.length>999){t.getView().byId("idTabNewMeter").setCount("+999")}else{t.getView().byId("idTabNewMeter").setCount(a.length)}console.log(a);for(var o in a){if(a.hasOwnProperty(o)){a[o].deviceCategory=a[o].deviceCategory.replace(/^0+/,"");a[o].createdDate=a[o].createdDate.split("T")[0].concat(" ").concat(a[o].createdDate.split("T")[1].substring(0,8));a[o].upadateDate=a[o].upadateDate.split("T")[0].concat(" ").concat(a[o].upadateDate.split("T")[1].substring(0,8));a[o].ui5User=a[o].ui5User.toUpperCase();var r=a[o].status;console.log(r);if(a[o].status==1){a[o].status="بأنتظار الموافقة"}if(a[o].status==2){a[o].status="تمت الموافقة"}if(a[o].status==4){a[o].status="تعليق"}}}d=a;var s=t.getView().byId("idTableOffline");var n=new sap.ui.model.json.JSONModel;n.setData(d);console.log(n);s.setModel(n);var l={busy:false,order:0};var n=new i(l);t.getView().setModel(n,"appView")});var a={async:true,crossDomain:true,url:"https://portal.jepco.com.jo/MeterReplacmentPortalApisPRD/api/TbMeterReplacment/GetAllDataWithoutImages",method:"POST",headers:{"content-type":"application/json","cache-control":"no-cache"},processData:false,data:f};$.ajax(a).done(function(e){var a=e;console.log(a);if(a.length>999){t.getView().byId("idTabOtherMeter").setCount("+999")}else{t.getView().byId("idTabOtherMeter").setCount(a.length)}for(var o in a){if(a.hasOwnProperty(o)){a[o].createdDate=a[o].createdDate.split("T")[0];a[o].upadateDate=a[o].upadateDate.split("T")[0];a[o].ui5User=a[o].ui5User.toUpperCase();a[o].updateBy=a[o].updateBy.toUpperCase();var r=a[o].status;console.log(r);if(a[o].status==1){a[o].status="بأنتظار الموافقة"}if(a[o].status==2){a[o].status="تمت الموافقة"}if(a[o].status==4){a[o].status="تعليق"}}}d=a;var s=t.getView().byId("idTableOtherMeter");var n=new sap.ui.model.json.JSONModel;n.setData(d);s.setModel(n);var l={busy:false,order:0};var n=new i(l);t.getView().setModel(n,"appView")});var o=[];var r={};for(let e=0;e<u.length;e++){r={ui5User:u[e]};o.push(r)}let s=sap.ui.getCore().getModel().getProperty("/globalData/oUserName");console.log("oUserID---------------------------"+s);var n="UAN"+"-"+s;var l=[];$.ajax({type:"POST",url:"https://portal.jepco.com.jo/JepcoSAPProxyPRD/SapProxy/GetEng_MeterSet",dataType:"json",contentType:"application/json",data:JSON.stringify({strEngUserName:n}),success:function(e,a,o){var r=o.responseJSON.d.results;for(const e in r){l.push({firstColumnText:r[e].engTechUser.split("-")[0],secondColumnText:r[e].engTechUser.split("-")[1]});var s=new sap.ui.model.json.JSONModel({items:l});t.getView().setModel(s,"userModel")}},error:function(e){}});var a={async:true,crossDomain:true,url:"https://portal.jepco.com.jo/MeterReplacmentPortalApisPRD/api/TbTechnicalNotesAndIncident/GetNotesByUi5UserIds",method:"POST",headers:{"content-type":"application/json","cache-control":"no-cache","postman-token":"ab0289cd-5f6f-07d0-2596-e05cebc7bc4b"},processData:false,data:JSON.stringify(o)};$.ajax(a).done(function(e){console.log(e);for(var a in e){if(e.hasOwnProperty(a)){e[a].createdDate=e[a].createdDate.split("T")[0];e[a].ui5User=e[a].ui5User.toUpperCase();var o=e[a].tarifDesc;console.log(o);if(e[a].tarifDesc==1){e[a].tarifDesc="ملاحظات خاصة بالخزانة الكهربائية"}if(e[a].tarifDesc==2){e[a].tarifDesc="ملاحظات خاصة بالعداد"}if(e[a].tarifDesc==3){e[a].tarifDesc="عبث"}if(e[a].tarifDesc>3){e[a].tarifDesc="ملاحظات اخرى"}}}h=e;var r=t.getView().byId("idTechnicalNotes");var s=new sap.ui.model.json.JSONModel;s.setData(h);r.setModel(s);var n={busy:false,order:0};var s=new i(n);t.getView().setModel(s,"appView")})},onInit:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.attachRoutePatternMatched(this._handleRouteMatched,this)},onRefresh:function(){let e=this;e._handleRouteMatched()},onShowMore:function(e){var t=e.getSource();var a=t.getBindingContext();var o=a.getObject();var r=this;let s="https://portal.jepco.com.jo/MeterReplacmentPortalApisPRD/api/TbMeterReplacment/GetMeterReplacmentByID?ID="+o.id+"";$.ajax({type:"GET",url:s,dataType:"json",contentType:"application/json",success:function(e,t,a){e[0].deviceCategory=e[0].deviceCategory.replace(/^0+/,"");console.log(e);console.log(t);console.log(a);o.impimageNm=e[0].impimageNm;o.impimageOm=e[0].impimageOm;o.expimageNm=e[0].expimageNm;o.expimageOm=e[0].expimageOm;var s=new sap.ui.model.json.JSONModel(o);r.getOwnerComponent().setModel(s,"MoreInfoData");var n=sap.ui.core.UIComponent.getRouterFor(r);n.navTo("MoreInfo")},error:function(e){console.log(e)}})},onSearchMeter:function(e){var o=1;let r=e.getParameter("id").split("--").pop();if(e.getParameter("id").split("--").pop()=="searchOldMeter"){var s=this.getView().byId("searchOldMeter").getValue();o=1}if(e.getParameter("id").split("--").pop()=="searchNewMeter"){var s=this.getView().byId("searchNewMeter").getValue();o=0}if(e.getParameter("id").split("--").pop()=="searchOldMeterAll"){var s=this.getView().byId("searchOldMeterAll").getValue();o=1}if(e.getParameter("id").split("--").pop()=="searchNewMeterAll"){var s=this.getView().byId("searchNewMeterAll").getValue();o=0}var n={MeterNumber:s,OldMeterFalg:o};var l=JSON.stringify(n);var c={async:true,crossDomain:true,url:"https://portal.jepco.com.jo/MeterReplacmentPortalApisPRD/api/TbMeterReplacment/GetMeterReplacmentByMeterNumber?MeterNumber="+s+"&OldMeterFalg="+o,method:"GET",headers:{"content-type":"application/json","cache-control":"no-cache"},processData:false,data:l};if(r=="searchOldMeterAll"||r=="searchNewMeterAll"){var p=this.getView().byId("idTableOtherMeter")}else{p=this.getView().byId("idTableOffline")}var u=this;t.show();$.ajax(c).done(function(e){var o=e;console.log(o);if(o.length=="0"){a.error("رقم العداد غير موجود");u.getView().byId("searchOldMeter").setValue("");u.getView().byId("searchNewMeter").setValue("");u.getView().byId("searchOldMeterAll").setValue("");u.getView().byId("searchNewMeterAll").setValue("");t.hide();return}for(var r in o){if(o.hasOwnProperty(r)){o[r].createdDate=o[r].createdDate.split("T")[0].concat(" ").concat(o[r].createdDate.split("T")[1].substring(0,8));o[r].upadateDate=o[r].upadateDate.split("T")[0].concat(" ").concat(o[r].upadateDate.split("T")[1].substring(0,8));o[r].ui5User=o[r].ui5User.toUpperCase();var s=o[r].status;console.log(s);if(o[r].status==1){o[r].status="بأنتظار الموافقة"}if(o[r].status==2){o[r].status="تمت الموافقة"}if(o[r].status==4){o[r].status="تعليق"}}}d=o;var n=new sap.ui.model.json.JSONModel;n.setData(d);console.log(n);p.setModel(n);var l={busy:false,order:0};var n=new i(l);u.getView().setModel(n,"appView");u.getView().byId("searchOldMeter").setValue("");u.getView().byId("searchNewMeter").setValue("");u.getView().byId("searchOldMeterAll").setValue("");u.getView().byId("searchNewMeterAll").setValue("");t.hide()})},onSort:function(){var e=this.getView(),t=[undefined,"asc","desc"],a=["sortNone","sortAscending","sortDescending"],r,s=e.getModel("appView").getProperty("/order");s=(s+1)%t.length;var n=t[s];e.getModel("appView").setProperty("/order",s);e.byId("idTableOffline").getBinding("items").sort(n&&new o("status",n==="desc"));e.byId("idTableOtherMeter").getBinding("items").sort(n&&new o("status",n==="desc"))},onSortByDate:function(){var e=this.getView(),t=[undefined,"asc","desc"],a=["sortNone","sortAscending","sortDescending"],r,s=e.getModel("appView").getProperty("/order");s=(s+1)%t.length;var n=t[s];e.getModel("appView").setProperty("/order",s);e.byId("idTechnicalNotes").getBinding("items").sort(n&&new o("createdDate",n==="asc"))},onSortUi5User:function(){var e=this.getView(),t=[undefined,"asc","desc"],a=["sortNone","sortAscending","sortDescending"],r,s=e.getModel("appView").getProperty("/order");s=(s+1)%t.length;var n=t[s];e.getModel("appView").setProperty("/order",s);e.byId("idTechnicalNotes").getBinding("items").sort(n&&new o("ui5User",n==="desc"))},onSortUser:function(){var e=this.getView(),t=[undefined,"asc","desc"],a=["sortNone","sortAscending","sortDescending"],r,s=e.getModel("appView").getProperty("/order");s=(s+1)%t.length;var n=t[s];e.getModel("appView").setProperty("/order",s);e.byId("idTableOffline").getBinding("items").sort(n&&new o("ui5User",n==="desc"));e.byId("idTableOtherMeter").getBinding("items").sort(n&&new o("ui5User",n==="desc"))},onCreatedDate:function(){var e=this.getView(),t=[undefined,"asc","desc"],a=["sortNone","sortAscending","sortDescending"],r,s=e.getModel("appView").getProperty("/order");s=(s+1)%t.length;var n=t[s];e.getModel("appView").setProperty("/order",s);e.byId("idTableOffline").getBinding("items").sort(n&&new o("createdDate",n==="desc"));e.byId("idTableOtherMeter").getBinding("items").sort(n&&new o("createdDate",n==="desc"))},onEnterItems:function(e){console.log(e.getSource().mProperties.src);var t=e.getSource().mProperties.src;var a=new sap.m.HBox({alignItems:"Center",wrap:"Wrap",justifyContent:"Start",items:[new sap.m.Image({id:"image_not_decorative",src:t,alt:"test image",decorative:false})]});this.oDefaultDialog=new l({title:"الصورة",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",content:[a]})],endButton:new c({text:"Close",press:function(){this.oDefaultDialog.close();this.oDefaultDialog.destroyContent()}.bind(this)})});this.getView().addDependent(this.oDefaultDialog);this.oDefaultDialog.open()}})});